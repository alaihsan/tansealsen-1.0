{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Navigation Back -->
    <div class="mb-6">
        <a href="{{ url_for('main.home') }}" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
            <i class="fas fa-arrow-left mr-1"></i> Kembali ke Dashboard
        </a>
    </div>

    <!-- Student Profile Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-6 text-white">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-blue-600 font-bold text-3xl border-4 border-white/30 shadow-md">
                    {{ student.name[:2] }}
                </div>
                <div class="text-center sm:text-left flex-1">
                    <h1 class="text-2xl font-bold">{{ student.name }}</h1>
                    <div class="flex flex-wrap justify-center sm:justify-start gap-2 mt-2 opacity-90">
                        <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-medium">
                            <i class="fas fa-id-card mr-1"></i> NIS: {{ student.nis }}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-medium">
                            <i class="fas fa-school mr-1"></i> Kelas: {{ student.classroom.name }}
                        </span>
                    </div>
                </div>
                <div class="text-center bg-white/10 rounded-lg p-3 backdrop-blur-sm min-w-[100px]">
                    <div class="text-xs uppercase tracking-wider opacity-80 mb-1">Total Poin</div>
                    <div class="text-3xl font-bold">{{ total_points }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Layout Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Statistics -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Stats Widget -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-chart-pie mr-2 text-primary"></i>
                        Statistik
                    </div>
                    <button id="toggleStudentStats" class="text-xs text-blue-600 hover:text-blue-800 transition-colors bg-blue-50 px-2 py-1 rounded" title="Ganti Mode">
                        <i class="fas fa-globe mr-1"></i>
                        <span id="studentStatsMode">Global</span>
                    </button>
                </h3>
                
                <div class="space-y-3 text-sm">
                    <!-- Global Statistics (Hidden by default or toggled) -->
                    <div id="globalStudentStats" class="space-y-2">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                <span class="text-gray-600">Ringan</span>
                            </div>
                            <span class="font-semibold text-gray-900">{{ total_ringan if total_ringan is defined else 0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                <span class="text-gray-600">Sedang</span>
                            </div>
                            <span class="font-semibold text-gray-900">{{ total_sedang if total_sedang is defined else 0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                <span class="text-gray-600">Berat</span>
                            </div>
                            <span class="font-semibold text-gray-900">{{ total_berat if total_berat is defined else 0 }}</span>
                        </div>
                    </div>
                    
                    <!-- Student Statistics (Calculated via JS) -->
                    <div id="currentStudentStats" class="space-y-2 hidden">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                <span class="text-gray-600">Ringan</span>
                            </div>
                            <span class="font-semibold text-gray-900" id="student-stat-ringan">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                <span class="text-gray-600">Sedang</span>
                            </div>
                            <span class="font-semibold text-gray-900" id="student-stat-sedang">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-red-600 rounded-full mr-2"></span>
                                <span class="text-gray-600">Berat</span>
                            </div>
                            <span class="font-semibold text-gray-900" id="student-stat-berat">0</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="pt-2 border-t border-gray-100 mt-2">
                        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden flex" id="student-category-progress">
                            <div class="h-full transition-all duration-500 flex-shrink-0" style="width: 0%; background-color: #22c55e;"></div>
                            <div class="h-full transition-all duration-500 flex-shrink-0" style="width: 0%; background-color: #f97316;"></div>
                            <div class="h-full transition-all duration-500 flex-shrink-0" style="width: 0%; background-color: #dc2626;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: History Timeline -->
        <div class="lg:col-span-2">
            <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-history text-gray-400 mr-2"></i> Riwayat Pelanggaran
            </h2>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                {% if student.violations %}
                    <div class="flow-root">
                        <ul role="list" class="divide-y divide-gray-200 violation-list-container">
                            {% for v in student.violations|sort(attribute='date_posted', reverse=True) %}
                            <li class="p-6 hover:bg-gray-50 transition-colors violation-item"
                                data-kategori="{{ v.kategori_pelanggaran }}">
                                <div class="flex items-start space-x-4">
                                    <div class="flex-shrink-0 mt-1">
                                        {% if v.points <= 10 %}
                                            <span class="flex items-center justify-center h-8 w-8 rounded-full bg-green-100 text-green-600 category-indicator" data-type="Ringan">
                                                <i class="fas fa-check-circle"></i>
                                            </span>
                                        {% elif v.points <= 20 %}
                                            <span class="flex items-center justify-center h-8 w-8 rounded-full bg-yellow-100 text-yellow-600 category-indicator" data-type="Sedang">
                                                <i class="fas fa-exclamation-circle"></i>
                                            </span>
                                        {% else %}
                                            <span class="flex items-center justify-center h-8 w-8 rounded-full bg-red-100 text-red-600 category-indicator" data-type="Berat">
                                                <i class="fas fa-times-circle"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex flex-col sm:flex-row sm:justify-between mb-1">
                                            <p class="text-sm font-medium text-gray-900 truncate">
                                                {{ v.description }}
                                            </p>
                                            <div class="text-xs text-gray-500 whitespace-nowrap mt-1 sm:mt-0 flex items-center">
                                                <i class="far fa-calendar-alt mr-1"></i>
                                                {{ v.tanggal_dicatat.strftime('%d %B %Y, %H:%M') }}
                                            </div>
                                        </div>
                                        <div class="flex items-center text-sm text-gray-500 mt-2">
                                            <span class="bg-gray-100 px-2 py-0.5 rounded text-xs font-mono mr-2">
                                                +{{ v.points }} Poin
                                            </span>
                                            {% if v.kategori_pelanggaran %}
                                            <span class="text-xs border border-gray-200 px-2 py-0.5 rounded
                                                {% if v.kategori_pelanggaran == 'Ringan' %}bg-green-50 text-green-700 border-green-200
                                                {% elif v.kategori_pelanggaran == 'Sedang' %}bg-yellow-50 text-yellow-700 border-yellow-200
                                                {% elif v.kategori_pelanggaran == 'Berat' %}bg-red-50 text-red-700 border-red-200{% endif %}">
                                                {{ v.kategori_pelanggaran }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% if v.di_input_oleh %}
                                        <p class="text-xs text-gray-400 mt-2">
                                            Dicatat oleh: {{ v.di_input_oleh }}
                                        </p>
                                        {% endif %}
                                        
                                        {% if v.bukti_file %}
                                        <div class="mt-3">
                                            <a href="{{ url_for('static', filename='uploads/' + v.bukti_file) }}" target="_blank" class="inline-flex items-center text-xs text-blue-600 hover:text-blue-800">
                                                <i class="fas fa-paperclip mr-1"></i> Lihat Bukti Foto
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <div class="p-12 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <i class="fas fa-award text-green-600 text-xl"></i>
                        </div>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Siswa Teladan</h3>
                        <p class="mt-1 text-sm text-gray-500">Belum ada catatan pelanggaran untuk siswa ini.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Data Passing Aman (Pattern yang diminta) -->
<script id="global-stats-json" type="application/json">
{
    "ringan": {{ total_ringan if total_ringan is defined else 0 }},
    "sedang": {{ total_sedang if total_sedang is defined else 0 }},
    "berat": {{ total_berat if total_berat is defined else 0 }}
}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Helper: Parse JSON data ---
        function getJsonData(elementId) {
            try {
                return JSON.parse(document.getElementById(elementId).textContent);
            } catch (e) {
                console.error("Error parsing JSON data", e);
                return {ringan: 0, sedang: 0, berat: 0};
            }
        }

        // --- Calculate Student specific stats from DOM elements ---
        function calculateStudentStats() {
            const items = document.querySelectorAll('.violation-item');
            let stats = { ringan: 0, sedang: 0, berat: 0 };
            
            items.forEach(item => {
                // Check category from data attribute or visual indicator
                const indicator = item.querySelector('.category-indicator');
                if (indicator) {
                    const type = indicator.getAttribute('data-type');
                    if (type === 'Ringan') stats.ringan++;
                    else if (type === 'Sedang') stats.sedang++;
                    else if (type === 'Berat') stats.berat++;
                }
            });
            return stats;
        }

        // --- Update UI Display ---
        function updateStatsDisplay(stats) {
            document.getElementById('student-stat-ringan').textContent = stats.ringan;
            document.getElementById('student-stat-sedang').textContent = stats.sedang;
            document.getElementById('student-stat-berat').textContent = stats.berat;
            
            // Progress Bar
            const total = stats.ringan + stats.sedang + stats.berat;
            const container = document.getElementById('student-category-progress');
            
            if (total > 0 && container) {
                const pRingan = (stats.ringan / total) * 100;
                const pSedang = (stats.sedang / total) * 100;
                const pBerat = (stats.berat / total) * 100;
                
                container.innerHTML = `
                    <div class="h-full transition-all duration-500" style="width: ${pRingan}%; background-color: #22c55e;"></div>
                    <div class="h-full transition-all duration-500" style="width: ${pSedang}%; background-color: #f97316;"></div>
                    <div class="h-full transition-all duration-500" style="width: ${pBerat}%; background-color: #dc2626;"></div>
                `;
            }
        }

        // --- Toggle Logic ---
        const toggleBtn = document.getElementById('toggleStudentStats');
        const globalStatsDiv = document.getElementById('globalStudentStats');
        const currentStatsDiv = document.getElementById('currentStudentStats');
        const modeLabel = document.getElementById('studentStatsMode');
        
        // Get Data
        const globalStats = getJsonData('global-stats-json');
        const studentStats = calculateStudentStats();

        // Initial render (if student stats view is default or pre-calculated)
        // Note: HTML defaults to showing Global stats div.
        
        toggleBtn.addEventListener('click', function() {
            // Animasi kecil
            this.style.transform = 'scale(0.95)';
            setTimeout(() => this.style.transform = 'scale(1)', 100);

            if (globalStatsDiv.classList.contains('hidden')) {
                // Switch to Global
                globalStatsDiv.classList.remove('hidden');
                currentStatsDiv.classList.add('hidden');
                modeLabel.textContent = 'Global';
                this.classList.replace('bg-green-50', 'bg-blue-50');
                this.classList.replace('text-green-600', 'text-blue-600');
            } else {
                // Switch to Student
                globalStatsDiv.classList.add('hidden');
                currentStatsDiv.classList.remove('hidden');
                modeLabel.textContent = 'Siswa Ini';
                this.classList.replace('bg-blue-50', 'bg-green-50');
                this.classList.replace('text-blue-600', 'text-green-600');
                
                updateStatsDisplay(studentStats);
            }
        });
    });
</script>
{% endblock %}