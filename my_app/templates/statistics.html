{% extends "base.html" %}

{% block title %}Statistik Pelanggaran{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-chart-pie mr-3 text-primary"></i>
            Statistik Pelanggaran
        </h1>
        <p class="text-gray-600 mt-2">Analisis data pelanggaran siswa secara visual</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Card 1: Total Pelanggaran -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Total Pelanggaran</p>
                    <h2 class="text-3xl font-bold text-gray-800" id="totalCount">-</h2>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Card 2: Bulan Ini -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Bulan Ini</p>
                    <h2 class="text-3xl font-bold text-gray-800" id="monthlyCount">-</h2>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                    <i class="fas fa-calendar-alt text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Card 3: Kategori Terbanyak -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Kategori Terbanyak</p>
                    <h2 class="text-xl font-bold text-gray-800" id="topCategory">-</h2>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                    <i class="fas fa-tags text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Bar Chart: Violation by Class -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-school mr-2 text-indigo-600"></i>
                Pelanggaran per Kelas
            </h3>
            <div class="relative h-64 w-full">
                <canvas id="classChart"></canvas>
            </div>
        </div>

        <!-- Pie Chart: Violation by Category -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-chart-pie mr-2 text-pink-600"></i>
                Kategori Pelanggaran
            </h3>
            <div class="relative h-64 w-full flex justify-center">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Table (Optional) -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class="fas fa-history mr-2 text-gray-600"></i>
                Tren Bulanan
            </h3>
        </div>
        <div class="p-6">
            <div class="relative h-64 w-full">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<!-- Embedding JSON data safely for JS to read -->
<script id="stats-data" type="application/json">
    {{ stats_data | tojson | default('{}') | safe }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ambil data dari script tag JSON untuk menghindari syntax error di editor
        let statsData = {};
        try {
            const dataElement = document.getElementById('stats-data');
            if (dataElement && dataElement.textContent) {
                 statsData = JSON.parse(dataElement.textContent);
            }
        } catch (e) {
            console.error("Error parsing stats data:", e);
        }
        
        console.log("Stats Data:", statsData);

        // --- 1. Populate Summary Cards ---
        if (statsData.summary) {
            document.getElementById('totalCount').textContent = statsData.summary.total || '0';
            document.getElementById('monthlyCount').textContent = statsData.summary.this_month || '0';
            document.getElementById('topCategory').textContent = statsData.summary.top_category || '-';
        }

        // --- 2. Bar Chart: By Class ---
        const classChartEl = document.getElementById('classChart');
        if (classChartEl) {
            const classCtx = classChartEl.getContext('2d');
            if (statsData.by_class && statsData.by_class.labels && statsData.by_class.labels.length > 0) {
                new Chart(classCtx, {
                    type: 'bar',
                    data: {
                        labels: statsData.by_class.labels,
                        datasets: [{
                            label: 'Jumlah Pelanggaran',
                            data: statsData.by_class.values,
                            backgroundColor: 'rgba(79, 70, 229, 0.6)', // Indigo-600
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            } else {
                showEmptyState(classCtx, "Belum ada data kelas");
            }
        }

        // --- 3. Doughnut Chart: By Category ---
        const categoryChartEl = document.getElementById('categoryChart');
        if (categoryChartEl) {
            const catCtx = categoryChartEl.getContext('2d');
            if (statsData.by_category && statsData.by_category.labels && statsData.by_category.labels.length > 0) {
                new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statsData.by_category.labels,
                        datasets: [{
                            data: statsData.by_category.values,
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.7)',  // Red
                                'rgba(245, 158, 11, 0.7)', // Amber
                                'rgba(16, 185, 129, 0.7)', // Emerald
                                'rgba(59, 130, 246, 0.7)'  // Blue
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            } else {
                 const catCtx = categoryChartEl.getContext('2d');
                 showEmptyState(catCtx, "Belum ada data kategori");
            }
        }

         // --- 4. Line Chart: Monthly Trend ---
        const trendChartEl = document.getElementById('trendChart');
        if (trendChartEl) {
            const trendCtx = trendChartEl.getContext('2d');
            if (statsData.monthly_trend && statsData.monthly_trend.labels && statsData.monthly_trend.labels.length > 0) {
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: statsData.monthly_trend.labels,
                        datasets: [{
                            label: 'Trend Pelanggaran',
                            data: statsData.monthly_trend.values,
                            borderColor: 'rgba(14, 165, 233, 1)', // Sky-500
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            } else {
                showEmptyState(trendCtx, "Belum ada data tren");
            }
        }

        // Helper function untuk menampilkan pesan kosong pada canvas
        function showEmptyState(ctx, message) {
            // Save context state
            ctx.save();
            // Clear canvas
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            ctx.font = "14px 'Inter', sans-serif";
            ctx.fillStyle = "#9ca3af";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
            // Restore context state
            ctx.restore();
        }
    });
</script>
{% endblock %}