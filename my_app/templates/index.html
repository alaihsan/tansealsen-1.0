{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="{ 
    galleryOpen: false, 
    currentPhotos: [], 
    currentIndex: 0,
    openGallery(photos) {
        if (photos.length > 0) {
            this.currentPhotos = photos;
            this.currentIndex = 0;
            this.galleryOpen = true;
        }
    },
    nextPhoto() {
        this.currentIndex = (this.currentIndex + 1) % this.currentPhotos.length;
    },
    prevPhoto() {
        this.currentIndex = (this.currentIndex - 1 + this.currentPhotos.length) % this.currentPhotos.length;
    }
}">

    <div class="mb-8 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Dashboard Pelanggaran</h1>
            <p class="text-sm text-gray-500">Rekap data siswa sekolah {{ current_user.school.name }}</p>
        </div>
        <a href="{{ url_for('main.add_violation') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center justify-center">
            <i class="fas fa-plus mr-2"></i> Input Pelanggaran
        </a>
    </div>

    <!-- STATS CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 text-blue-600 rounded-lg mr-4"><i class="fas fa-users text-xl"></i></div>
                <div><p class="text-sm text-gray-500">Total Siswa</p><p class="text-2xl font-bold text-gray-900">{{ total_students }}</p></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-red-100 text-red-600 rounded-lg mr-4"><i class="fas fa-exclamation-triangle text-xl"></i></div>
                <div><p class="text-sm text-gray-500">Total Pelanggaran</p><p class="text-2xl font-bold text-gray-900">{{ total_violations }}</p></div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 text-green-600 rounded-lg mr-4"><i class="fas fa-school text-xl"></i></div>
                <div><p class="text-sm text-gray-500">Total Kelas</p><p class="text-2xl font-bold text-gray-900">{{ total_classes }}</p></div>
            </div>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" name="search" placeholder="Cari nama siswa..." value="{{ search_query }}" class="border rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500">
            
            <select name="category" class="border rounded-lg px-4 py-2 text-sm bg-white">
                <option value="">Semua Kategori</option>
                {% for cat in categories %}
                    <option value="{{ cat.name }}" {% if category_filter == cat.name %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
            
            <select name="date_range" class="border rounded-lg px-4 py-2 text-sm bg-white">
                <option value="">Semua Waktu</option>
                <option value="today" {% if date_range_value == 'today' %}selected{% endif %}>Hari Ini</option>
                <option value="week" {% if date_range_value == 'week' %}selected{% endif %}>7 Hari Terakhir</option>
                <option value="month" {% if date_range_value == 'month' %}selected{% endif %}>30 Hari Terakhir</option>
            </select>
            
            <button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-900">Filter</button>
        </form>
    </div>

    <!-- TABLE -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pelanggaran</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Poin</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bukti</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for violation in pelanggaran_pagination.items %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ violation.tanggal_kejadian }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <a href="{{ url_for('main.student_history', student_id=violation.student.id) }}" class="text-blue-600 hover:underline">
                                {{ violation.student.name }}
                            </a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ violation.student.classroom.name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="{{ violation.description }}">
                            <span class="block font-medium text-gray-700">{{ violation.kategori_pelanggaran }}</span>
                            {{ violation.description }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if violation.points >= 20 %}bg-red-100 text-red-800{% elif violation.points >= 10 %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">
                                +{{ violation.points }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if violation.photos|length > 0 %}
                                <!-- PREPARE DATA FOR ALPINE JS -->
                                <button @click="openGallery([
                                    {% for photo in violation.photos %}
                                        '{{ url_for('static', filename='uploads/' + photo.filename) }}'{% if not loop.last %},{% endif %}
                                    {% endfor %}
                                ])" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-xs font-bold border border-blue-200 px-2 py-1 rounded bg-blue-50">
                                    <i class="fas fa-images"></i> {{ violation.photos|length }} Foto
                                </button>
                            {% else %}
                                <span class="text-gray-400 text-xs">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-10 text-center text-gray-500">Tidak ada data pelanggaran ditemukan.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="bg-white px-4 py-3 border-t border-gray-200 flex items-center justify-between sm:px-6">
            {% if pelanggaran_pagination.pages > 1 %}
            <div class="flex-1 flex justify-between sm:justify-end gap-2">
                {% if pelanggaran_pagination.has_prev %}
                    <a href="{{ url_for('main.home', page=pelanggaran_pagination.prev_num, search=search_query, category=category_filter, date_range=date_range_value) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                {% endif %}
                {% if pelanggaran_pagination.has_next %}
                    <a href="{{ url_for('main.home', page=pelanggaran_pagination.next_num, search=search_query, category=category_filter, date_range=date_range_value) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- MODAL GALLERY (ALPINE JS) -->
    <div x-show="galleryOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-90" style="display: none;" x-cloak>
        <!-- Close Button -->
        <button @click="galleryOpen = false" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-50">
            <i class="fas fa-times"></i>
        </button>

        <!-- Main Image Container -->
        <div class="relative w-full max-w-4xl h-full max-h-[90vh] flex items-center justify-center p-4">
            
            <!-- Prev Button -->
            <button @click="prevPhoto" class="absolute left-2 md:-left-12 text-white text-4xl hover:text-gray-300 z-10 p-2" x-show="currentPhotos.length > 1">
                <i class="fas fa-chevron-left"></i>
            </button>

            <!-- Image -->
            <img :src="currentPhotos[currentIndex]" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl transition-all duration-300" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 scale-90"
                 x-transition:enter-end="opacity-100 scale-100">

            <!-- Next Button -->
            <button @click="nextPhoto" class="absolute right-2 md:-right-12 text-white text-4xl hover:text-gray-300 z-10 p-2" x-show="currentPhotos.length > 1">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Counter -->
            <div class="absolute bottom-[-40px] text-white text-sm font-medium">
                <span x-text="currentIndex + 1"></span> / <span x-text="currentPhotos.length"></span>
            </div>
        </div>
    </div>

</div>
{% endblock %}