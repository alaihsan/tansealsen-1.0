{% extends "base.html" %}

{% block title %}Detail Kelas {{ classroom.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8" x-data="{ 
    activeTab: 'students',
    deleteModalOpen: false,
    studentToDeleteId: null,
    studentToDeleteName: '',
    
    confirmDelete(id, name) {
        this.studentToDeleteId = id;
        this.studentToDeleteName = name;
        this.deleteModalOpen = true;
    }
}">
    
    <!-- HEADER SECTION -->
    <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
                <a href="{{ url_for('main.manage_classes') }}" class="group flex items-center hover:text-blue-600 transition-colors">
                    <div class="w-6 h-6 rounded-full bg-gray-100 group-hover:bg-blue-100 flex items-center justify-center mr-2 transition-colors">
                        <i class="fas fa-arrow-left text-xs"></i>
                    </div>
                    Kembali ke Kelas
                </a>
            </div>
            <div class="flex items-baseline gap-3">
                <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Kelas {{ classroom.name }}</h1>
                <span class="px-2.5 py-0.5 rounded-full bg-blue-50 text-blue-700 text-sm font-medium border border-blue-100">
                    {{ classroom.students|length }} Siswa
                </span>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-3">
            <!-- TOMBOL CETAK LAPORAN -->
            <a href="{{ url_for('main.print_class_report', class_id=classroom.id) }}" target="_blank" class="bg-white text-gray-700 hover:text-gray-900 border border-gray-300 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition-all flex items-center">
                <i class="fas fa-print mr-2 text-gray-500"></i> Cetak Laporan
            </a>
            
            <button @click="$dispatch('open-import-modal')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm hover:shadow transition-all flex items-center">
                <i class="fas fa-file-import mr-2"></i> Import Siswa
            </button>
            
            <button @click="$dispatch('open-mutation-modal')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm hover:shadow transition-all flex items-center">
                <i class="fas fa-exchange-alt mr-2"></i> Mutasi
            </button>
        </div>
    </div>

    <!-- CONTENT TABLE -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-16">No</th>
                        <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                        <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">NIS</th>
                        <!-- Kolom Poin disembunyikan -->
                        <!-- <th scope="col" class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Poin Pelanggaran</th> -->
                        <th scope="col" class="px-6 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for student in classroom.students|sort(attribute='name') %}
                    <tr class="hover:bg-gray-50 transition-colors group">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ loop.index }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 group-hover:text-blue-600 transition-colors">{{ student.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ student.nis }}</td>
                        
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-3 items-center">
                            
                            <!-- Tombol Detail -->
                            <a href="{{ url_for('main.student_history', student_id=student.id) }}" class="text-blue-600 hover:text-blue-800 inline-flex items-center" title="Lihat Detail">
                                Detail <i class="fas fa-chevron-right ml-1 text-xs transition-transform group-hover:translate-x-1"></i>
                            </a>

                            <!-- Tombol Hapus Siswa (Trigger Modal) -->
                            <button @click="confirmDelete({{ student.id }}, '{{ student.name }}')" class="text-gray-400 hover:text-red-600 transition-colors p-1 rounded-full hover:bg-red-50" title="Hapus Siswa">
                                <i class="fas fa-trash-alt"></i>
                            </button>

                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                    <i class="fas fa-user-slash text-gray-400"></i>
                                </div>
                                <p class="font-medium text-gray-900">Belum ada siswa</p>
                                <p class="text-sm mt-1">Gunakan tombol "Import Siswa" untuk menambahkan data.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL KONFIRMASI HAPUS SISWA -->
    <div x-show="deleteModalOpen" class="fixed inset-0 z-[60] flex items-center justify-center p-4" style="display: none;" x-cloak>
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity" 
             x-show="deleteModalOpen"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="deleteModalOpen = false"></div>

        <!-- Modal Content -->
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all"
             x-show="deleteModalOpen"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
            
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-red-100 mb-4 animate-bounce-slow">
                    <i class="fas fa-user-times text-2xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Hapus Siswa?</h3>
                <p class="text-sm text-gray-500 mb-6">
                    Anda akan menghapus siswa <span class="font-bold text-gray-800" x-text="studentToDeleteName"></span>. 
                    <br><span class="text-xs text-red-500 font-semibold mt-2 block bg-red-50 py-1 px-2 rounded border border-red-100">Perhatian: Siswa tidak dapat dihapus jika memiliki data pelanggaran.</span>
                </p>
                
                <div class="flex gap-3">
                    <button @click="deleteModalOpen = false" class="w-full py-2.5 px-4 bg-white border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200">
                        Batal
                    </button>
                    <form :action="'/student/delete/' + studentToDeleteId" method="POST" class="w-full">
                        <button type="submit" class="w-full py-2.5 px-4 bg-red-600 border border-transparent rounded-xl text-white font-bold hover:bg-red-700 shadow-lg shadow-red-200 transition-all transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Ya, Hapus
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL IMPORT -->
    <div x-data="{ open: false }" @open-import-modal.window="open = true" x-show="open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity" style="display: none;" x-cloak>
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6 relative transform transition-all" @click.outside="open = false">
            <button @click="open = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fas fa-times text-lg"></i></button>
            
            <div class="mb-5">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mb-3 text-blue-600">
                    <i class="fas fa-file-import text-lg"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900">Import Data Siswa</h3>
                <p class="text-sm text-gray-500 mt-1">Masukkan nama siswa, satu nama per baris.</p>
            </div>

            <form method="POST">
                <input type="hidden" name="import_students" value="1">
                <textarea name="student_names" rows="8" class="w-full border border-gray-300 rounded-lg p-3 text-sm mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-gray-50 focus:bg-white" placeholder="Contoh:&#10;Andi Saputra&#10;Budi Santoso&#10;Citra Lestari" required></textarea>
                
                <div class="flex justify-end gap-3">
                    <button type="button" @click="open = false" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg text-sm font-medium transition-colors">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm transition-colors flex items-center gap-2">
                        <i class="fas fa-upload"></i> Mulai Import
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL MUTASI -->
    <div x-data="{ open: false }" @open-mutation-modal.window="open = true" x-show="open" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity" style="display: none;" x-cloak>
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 p-6 relative transform transition-all" @click.outside="open = false">
            <button @click="open = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fas fa-times text-lg"></i></button>
            
            <div class="mb-5">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mb-3 text-orange-600">
                    <i class="fas fa-exchange-alt text-lg"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900">Mutasi Siswa</h3>
                <p class="text-sm text-gray-500 mt-1">Pindahkan siswa terpilih ke kelas lain.</p>
            </div>

            <form method="POST">
                <input type="hidden" name="mutate_students" value="1">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label>
                    <div class="border border-gray-300 rounded-lg max-h-48 overflow-y-auto p-1 bg-gray-50">
                        {% for student in classroom.students|sort(attribute='name') %}
                        <label class="flex items-center p-2 hover:bg-blue-50 rounded-md cursor-pointer transition-colors group">
                            <input type="checkbox" name="selected_students" value="{{ student.id }}" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                            <span class="ml-3 text-sm text-gray-700 group-hover:text-gray-900">{{ student.name }}</span>
                        </label>
                        {% else %}
                        <div class="p-4 text-center text-sm text-gray-500 italic">Tidak ada siswa di kelas ini.</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pindah ke Kelas</label>
                    <select name="target_class_id" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm rounded-lg" required>
                        <option value="">-- Pilih Kelas Tujuan --</option>
                        {% for cls in all_classes %}
                            <option value="{{ cls.id }}">{{ cls.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" @click="open = false" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg text-sm font-medium transition-colors">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 shadow-sm transition-colors flex items-center gap-2">
                        <i class="fas fa-check"></i> Proses Mutasi
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}