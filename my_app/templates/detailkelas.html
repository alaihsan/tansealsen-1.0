{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 gap-4">
        <div>
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-primary text-xl font-bold">
                    {{ classroom.name[:2] }}
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Kelas {{ classroom.name }}</h2>
                    <div class="flex items-center text-sm text-gray-500 mt-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ classroom.students|length }} Murid
                        </span>
                        <span class="mx-2">â€¢</span>
                        <span>Tahun Ajaran Aktif</span>
                    </div>
                </div>
            </div>
        </div>
        <a href="{{ url_for('main.manage_classes') }}" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-primary transition-all duration-200 shadow-sm">
            <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar Kelas
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- KOLOM KIRI: Daftar Murid & Mutasi (Lebar 2/3) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Card Daftar Murid -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-users mr-2 text-primary"></i> Daftar Murid
                    </h3>
                    <span class="text-xs text-gray-500 bg-white border border-gray-200 px-2 py-1 rounded">
                        <i class="fas fa-info-circle mr-1"></i> Centang untuk memindahkan
                    </span>
                </div>

                <div class="p-0">
                    {% if classroom.students %}
                    <form method="POST" id="mutationForm">
                        <input type="hidden" name="mutate_students" value="true">
                        
                        <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-primary focus:ring-primary h-4 w-4 cursor-pointer">
                                            </div>
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">NIS</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Nama Murid</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Poin</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for student in classroom.students %}
                                    <tr class="hover:bg-gray-50 transition-colors duration-150 group">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <input type="checkbox" name="selected_students" value="{{ student.id }}" class="item-checkbox rounded border-gray-300 text-primary focus:ring-primary h-4 w-4 cursor-pointer">
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ student.nis }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 group-hover:text-primary transition-colors">{{ student.name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                            {% set total = student.violations|sum(attribute='points') %}
                                            {% if total > 50 %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    {{ total }}
                                                </span>
                                            {% elif total > 20 %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    {{ total }}
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    {{ total }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <a href="{{ url_for('main.student_history', student_id=student.id) }}" class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded-md transition-colors">
                                                <i class="fas fa-history mr-1"></i> Riwayat
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Card Footer: Mutasi Control -->
                        <div class="bg-yellow-50 border-t border-yellow-100 p-4 sm:p-6">
                            <h4 class="text-sm font-bold text-yellow-800 mb-3 flex items-center">
                                <i class="fas fa-exchange-alt mr-2"></i> Mutasi Kelas (Pindah Kelas)
                            </h4>
                            <div class="flex flex-col sm:flex-row gap-3 items-center">
                                <div class="w-full sm:w-auto flex-grow relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-school text-gray-400"></i>
                                    </div>
                                    <select name="target_class_id" class="block w-full pl-10 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm rounded-lg" required>
                                        <option value="" selected disabled>-- Pilih Kelas Tujuan --</option>
                                        {% for cls in all_classes %}
                                            <option value="{{ cls.id }}">{{ cls.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-all duration-200" onclick="return confirm('Yakin ingin memindahkan siswa yang dipilih? Riwayat pelanggaran akan tetap tersimpan.')">
                                    Proses Pindah
                                    <i class="fas fa-chevron-right ml-2"></i>
                                </button>
                            </div>
                            <p class="text-xs text-yellow-700 mt-2">
                                <i class="fas fa-info-circle mr-1"></i> Pilih murid di tabel atas, tentukan kelas tujuan, lalu klik tombol proses.
                            </p>
                        </div>
                    </form>
                    {% else %}
                        <div class="text-center py-12 px-6">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user-slash text-4xl text-gray-300"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900">Belum ada murid</h3>
                            <p class="text-gray-500 mt-1 max-w-sm mx-auto">Kelas ini masih kosong. Gunakan form di sebelah kanan untuk menambahkan murid.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- KOLOM KANAN: Import / Tambah Murid (Lebar 1/3) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-green-200 sticky top-24 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-white border-b border-green-100">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center mr-2 text-green-600">
                            <i class="fas fa-file-import text-sm"></i>
                        </div>
                        Import / Tambah Murid
                    </h3>
                </div>
                
                <div class="p-6">
                    <div class="mb-4 bg-blue-50 rounded-lg p-3 border border-blue-100">
                        <p class="text-xs text-blue-800 flex items-start">
                            <i class="fas fa-lightbulb mt-0.5 mr-2 text-blue-500"></i>
                            <span>Masukkan nama murid, <strong>satu nama per baris</strong>. Sistem akan otomatis membuatkan NIS dummy.</span>
                        </p>
                    </div>

                    <form method="POST">
                        <input type="hidden" name="import_students" value="true">
                        
                        <div class="mb-4">
                            <label for="student_names" class="block text-sm font-medium text-gray-700 mb-2">
                                Daftar Nama Murid
                            </label>
                            <div class="relative">
                                <textarea name="student_names" id="student_names" rows="12" 
                                    class="shadow-sm focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm border-gray-300 rounded-lg p-3 font-mono text-sm leading-relaxed" 
                                    placeholder="Contoh:
Ahmad Dani
Budi Santoso
Citra Lestari
Dewi Anggraeni" required></textarea>
                                <div class="absolute bottom-3 right-3 text-xs text-gray-400 pointer-events-none">
                                    Tekan Enter untuk baris baru
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full flex justify-center items-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 hover:shadow-lg">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Tambahkan ke Kelas
                        </button>
                    </form>
                </div>
                <div class="bg-gray-50 px-6 py-3 border-t border-gray-100">
                    <p class="text-xs text-center text-gray-500">
                        Pastikan ejaan nama sudah benar sebelum disimpan.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Script checkbox "Pilih Semua"
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.item-checkbox');

        if(selectAll) {
            selectAll.addEventListener('change', function() {
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    // Visual feedback untuk baris yang dipilih
                    const row = cb.closest('tr');
                    if(this.checked) {
                        row.classList.add('bg-blue-50');
                    } else {
                        row.classList.remove('bg-blue-50');
                    }
                });
            });
        }

        // Visual feedback individual
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const row = this.closest('tr');
                if(this.checked) {
                    row.classList.add('bg-blue-50');
                } else {
                    row.classList.remove('bg-blue-50');
                }
                
                // Update state "Select All" jika ada satu yang tidak dicentang
                if(!this.checked) {
                    selectAll.checked = false;
                }
            });
        });
    });
</script>

<style>
    /* Custom Scrollbar untuk tabel */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>
{% endblock %}